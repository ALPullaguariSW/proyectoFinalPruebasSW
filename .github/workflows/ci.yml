name: CI - IntegraciÃ³n Continua

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-ci:
    name: Backend CI
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: Instalar dependencias del backend
      working-directory: ./backend
      run: npm ci
      
    - name: Ejecutar linting
      working-directory: ./backend
      run: npm run lint
      
    - name: Ejecutar tests unitarios del backend
      working-directory: ./backend
      run: npm test -- --coverage --watchAll=false --ci
      
    - name: Verificar cobertura del backend (debe ser â‰¥ 90%)
      working-directory: ./backend
      run: |
        if [ ! -f "coverage/lcov-report/index.html" ]; then
          echo "âŒ No se generÃ³ reporte de cobertura"
          exit 1
        fi
        
        # Extraer porcentaje de cobertura de lÃ­neas
        COVERAGE=$(grep -o 'class="strong">[0-9]*\.[0-9]*%' coverage/lcov-report/index.html | head -1 | grep -o '[0-9]*\.[0-9]*')
        echo "ðŸ“Š Cobertura del backend: ${COVERAGE}%"
        
        # Verificar que sea â‰¥ 90%
        if (( $(echo "$COVERAGE < 90" | bc -l) )); then
          echo "âŒ La cobertura del backend (${COVERAGE}%) es menor al 90% requerido"
          exit 1
        fi
        
        echo "âœ… Cobertura del backend (${COVERAGE}%) cumple con el requisito â‰¥ 90%"
      
    - name: Subir reporte de cobertura a Codecov
      uses: codecov/codecov-action@v3
      with:
        directory: ./backend/coverage
        flags: backend
        name: backend-coverage
        
    - name: Publicar artefactos de cobertura del backend
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage
        path: backend/coverage/
        retention-days: 30

  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Instalar dependencias del frontend
      working-directory: ./frontend
      run: npm ci
      
    - name: Ejecutar tests unitarios del frontend
      working-directory: ./frontend
      run: npm run test:ci
      
    - name: Verificar cobertura del frontend (debe ser â‰¥ 90%)
      working-directory: ./frontend
      run: |
        if [ ! -f "coverage/lcov-report/index.html" ]; then
          echo "âŒ No se generÃ³ reporte de cobertura"
          exit 1
        fi
        
        # Extraer porcentaje de cobertura de lÃ­neas
        COVERAGE=$(grep -o 'class="strong">[0-9]*\.[0-9]*%' coverage/lcov-report/index.html | head -1 | grep -o '[0-9]*\.[0-9]*')
        echo "ðŸ“Š Cobertura del frontend: ${COVERAGE}%"
        
        # Verificar que sea â‰¥ 90%
        if (( $(echo "$COVERAGE < 90" | bc -l) )); then
          echo "âŒ La cobertura del frontend (${COVERAGE}%) es menor al 90% requerido"
          exit 1
        fi
        
        echo "âœ… Cobertura del frontend (${COVERAGE}%) cumple con el requisito â‰¥ 90%"
      
    - name: Publicar artefactos de cobertura del frontend
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage
        path: frontend/coverage/
        retention-days: 30

  # Job de performance con k6
  performance-tests:
    name: Performance Tests (k6)
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci]
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: Instalar dependencias del backend
      working-directory: ./backend
      run: npm ci
      
    - name: Instalar k6
      run: |
        sudo gpg -k
        sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6
        
    - name: Iniciar backend en background
      working-directory: ./backend
      run: |
        npm start &
        sleep 15
        # Verificar que el backend estÃ© funcionando
        curl -f http://localhost:3000/api/health || echo "Backend aÃºn iniciando..."
        sleep 5
        
    - name: Ejecutar test de Ramp/Load
      run: |
        echo "ðŸš€ Ejecutando prueba de Ramp/Load..."
        k6 run tests/k6/ramp-load.js --out json=results-ramp.json
        
    - name: Ejecutar test de Spike
      run: |
        echo "âš¡ Ejecutando prueba de Spike..."
        k6 run tests/k6/spike.js --out json=results-spike.json
        
    - name: Ejecutar test de Soak
      run: |
        echo "ðŸƒâ€â™‚ï¸ Ejecutando prueba de Soak (endurance)..."
        k6 run tests/k6/soak.js --out json=results-soak.json
      
    - name: Publicar resultados de performance
      uses: actions/upload-artifact@v4
      with:
        name: k6-results
        path: results-*.json
        retention-days: 30
